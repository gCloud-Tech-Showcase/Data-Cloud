config {
  type: "view",
  schema: "sentiment_analysis",
  description: "Extract sentiment, category, and score from reviews using Gemini"
}

SELECT
  uri,

  -- Extract original review fields from JSON (data_string already converted from BYTES in subquery)
  JSON_EXTRACT_SCALAR(data_string, '$.platform') AS platform,
  JSON_EXTRACT_SCALAR(data_string, '$.review_id') AS review_id,
  JSON_EXTRACT_SCALAR(data_string, '$.user_pseudo_id') AS user_pseudo_id,
  JSON_EXTRACT_SCALAR(data_string, '$.user_name') AS user_name,
  PARSE_DATE('%Y-%m-%d', JSON_EXTRACT_SCALAR(data_string, '$.review_date')) AS review_date,
  CAST(JSON_EXTRACT_SCALAR(data_string, '$.rating') AS INT64) AS rating,
  JSON_EXTRACT_SCALAR(data_string, '$.app_version') AS app_version,
  CAST(JSON_EXTRACT_SCALAR(data_string, '$.thumbs_up_count') AS INT64) AS thumbs_up_count,
  JSON_EXTRACT_SCALAR(data_string, '$.review_text') AS review_text,
  JSON_EXTRACT_SCALAR(data_string, '$.developer_reply') AS developer_reply,

  -- Gemini-extracted sentiment fields
  JSON_EXTRACT_SCALAR(ml_generate_text_llm_result, '$.predictions[0].content.sentiment') AS sentiment,
  JSON_EXTRACT_SCALAR(ml_generate_text_llm_result, '$.predictions[0].content.category') AS category,
  SAFE_CAST(JSON_EXTRACT_SCALAR(ml_generate_text_llm_result, '$.predictions[0].content.score') AS FLOAT64) AS sentiment_score

FROM
  ML.GENERATE_TEXT(
    MODEL ${ref("gemini_sentiment_model")},
    (
      SELECT
        uri,
        SAFE_CONVERT_BYTES_TO_STRING(data) AS data_string,
        CONCAT(
          'Analyze this app review and return ONLY a JSON object with these exact fields:\n',
          '{"sentiment": "positive|neutral|negative", ',
          '"category": "performance|ads|difficulty|bugs|praise|other", ',
          '"score": <number from -1 to 1>}\n\n',
          'Review text: ',
          JSON_EXTRACT_SCALAR(SAFE_CONVERT_BYTES_TO_STRING(data), '$.review_text')
        ) AS prompt
      FROM ${ref("user_reviews")}
    ),
    STRUCT(
      0.2 AS temperature,
      1024 AS max_output_tokens,
      TRUE AS flatten_json_output
    )
  )